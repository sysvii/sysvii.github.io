<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
      <title>Title can be filled in later - postgres</title>
        <link>https://blog.drbar.nz</link>
        <description></description>
        <generator>Zola</generator>
        <language>en</language>
        <atom:link href="https://blog.drbar.nz/tags/postgres/rss.xml" rel="self" type="application/rss+xml"/>
        <lastBuildDate>Sat, 26 Sep 2020 00:00:00 +0000</lastBuildDate>
        <item>
            <title>Lazy Postgres</title>
            <pubDate>Mon, 23 Apr 2018 00:00:00 +0000</pubDate>
            <link>https://blog.drbar.nz/posts/lazy-postgres/</link>
            <guid>https://blog.drbar.nz/posts/lazy-postgres/</guid>
            <description>&lt;h2 id=&quot;background&quot;&gt;Background&lt;&#x2F;h2&gt;
&lt;p&gt;Sometimes I want to have local services for some development work outside of a
container but I don&#x27;t want to run them if I&#x27;m not using them.&lt;&#x2F;p&gt;
&lt;p&gt;After using &lt;code&gt;systemd&lt;&#x2F;code&gt; for a while I got curious about the &lt;code&gt;.socket&lt;&#x2F;code&gt; services. I
knew that they could lazily start services when they are needed but not really
sure what supported them.&lt;&#x2F;p&gt;
&lt;p&gt;So reading the &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.freedesktop.org&#x2F;software&#x2F;systemd&#x2F;man&#x2F;systemd.socket.html&quot;&gt;documentation&lt;&#x2F;a&gt; is a bit like drawing the &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.reddit.com&#x2F;r&#x2F;restofthefuckingowl&#x2F;&quot;&gt;rest of the owl&lt;&#x2F;a&gt;. It kinda tells you exactly what it is but not much in a way of what it lets you do.&lt;&#x2F;p&gt;
&lt;p&gt;I still don&#x27;t get exactly what is going on but my mental model for it all is:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;the &lt;code&gt;*.socket&lt;&#x2F;code&gt; system service will occupy the socket file or network port
you want to listen to&lt;&#x2F;li&gt;
&lt;li&gt;upon some initial connection &lt;code&gt;systemd&lt;&#x2F;code&gt; will start the prescribed service&lt;&#x2F;li&gt;
&lt;li&gt;&lt;em&gt;???&lt;&#x2F;em&gt;&lt;&#x2F;li&gt;
&lt;li&gt;profit&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;The documentation does elude to a initial connection hand over to the service
that has started for that &lt;em&gt;✨smooth transition✨&lt;&#x2F;em&gt; but I have never been able to get to
work.&lt;&#x2F;p&gt;
&lt;hr &#x2F;&gt;
&lt;p&gt;The recipe to success:&lt;&#x2F;p&gt;
&lt;h2 id=&quot;install&quot;&gt;Install&lt;&#x2F;h2&gt;
&lt;p&gt;The pre-requisites are having &lt;code&gt;postgresql&lt;&#x2F;code&gt; and &lt;code&gt;systemd&lt;&#x2F;code&gt; installed.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;create &lt;code&gt;postgresql.socket&lt;&#x2F;code&gt; into &lt;code&gt;&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&lt;&#x2F;code&gt; with the content
below&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;pre style=&quot;background-color:#f9f9f9;&quot;&gt;
&lt;code&gt;&lt;span style=&quot;color:#111111;&quot;&gt;[Socket]
ListenStream=&#x2F;run&#x2F;postgresql&#x2F;.s.PGSQL.5432

[Install]
WantedBy=sockets.target
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;ul&gt;
&lt;li&gt;run &lt;code&gt;sudo systemctl enable postgresql.socket&lt;&#x2F;code&gt; to enable the socket service&lt;&#x2F;li&gt;
&lt;li&gt;&lt;em&gt;Optional&lt;&#x2F;em&gt; run &lt;code&gt;sudo systemctl start postgresql.socket&lt;&#x2F;code&gt; to start listening
now &amp;amp; try it out yourself&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;uninstall&quot;&gt;Uninstall&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;run &lt;code&gt;sudo systemctl disable postgresql.socket&lt;&#x2F;code&gt; to disable the socket service&lt;&#x2F;li&gt;
&lt;li&gt;run &lt;code&gt;sudo systemctl stop postgresql.socket&lt;&#x2F;code&gt; to stop the listening socket&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;cavets&quot;&gt;Cavets&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;slow 1st time usage, may even fail 1st connection attempt&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;ListenStream&lt;&#x2F;code&gt; needs to point to where postgres would be, e.g. port &lt;code&gt;5432&lt;&#x2F;code&gt; or a socket file.&lt;&#x2F;li&gt;
&lt;li&gt;This has only been tested on Arch Linux&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;blockquote&gt;
&lt;p&gt;This post is largely based on an old &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;gist.github.com&#x2F;drbarnz&#x2F;eb7b941740af6e993f1cb1ddeb95beca&quot;&gt;gist&lt;&#x2F;a&gt; I did a few years back, so take this as a &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=szUJSXBjpJM&quot;&gt;dramatic reenactment&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
</description>
        </item>
    </channel>
</rss>
